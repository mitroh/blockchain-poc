{% extends "base.html" %}
{% block content %}
<br>
<center>
  <form action="/submit" id="dataform" method="post">
    <label for="financial_year"></label>
    <select name="financial_year" id="financial_year" required>
      <option value="">Select Financial Year</option>
      {% for year in range(2021, datetime.datetime.now().year + 2) %}
      <option value="{{ year }}-{{ year + 1 }}">{{ year }}-{{ year + 1 }}</option>
      {% endfor %}
    </select>
    <label for="document_type"></label>
    <select name="document_type" id="document_type" required>
      <option value="">Select Document Type</option>
      <option value="INV">Invoice</option>
      <option value="CRN">Credit Note</option>
      <option value="DBN">Debit Note</option>
    </select>
    <input type="number" name="document_number" placeholder="Document Number">
    <input type="number" name="gst_no" placeholder="GST Number">
    <input type="date" name="document_date" placeholder="Document Date">
    <input type="text" name="seller" placeholder="Seller">
    <input type="text" name="buyer" placeholder="Buyer">
    <input type="submit" value="Post">
  </form>
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  {% for category, message in messages %}
  {% if category == 'success' and 'Generated IRN:' in message %}
  <div class="irn-display">
    <h3>Transaction Successful!</h3>
    <p>{{ message }}</p>
  </div>
  {% endif %}
  {% endfor %}
  {% endif %}
  {% endwith %}
  <a href="{{ url_for('cancel_page') }}" class="cancel-btn">Cancel Invoice</a>
  <a href="{{ url_for('transactions') }}" class="transactions-btn">View Transactions</a>

</center>
<br>
<a href="{{node_address}}/mine" target="_blank"><button>Request to mine</button></a>
<button onclick="resync()">Resync</button>

<style>
  .irn-display {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 5px;
    padding: 15px;
    margin: 20px auto;
    max-width: 600px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  .irn-display h3 {
    color: #155724;
    margin-bottom: 10px;
  }
  .irn-display p {
    color: #1e7e34;
    font-family: monospace;
    font-size: 14px;
    word-break: break-all;
  }
  .cancel-btn, .transactions-btn {
    display: inline-block;
    padding: 10px 20px;
    color: white;
    text-decoration: none;
    border-radius: 3px;
    margin-top: 20px;
  }
  .cancel-btn {
    background-color: #f44336;
  }
  .transactions-btn {
    background-color: #4CAF50;
    margin-left: 10px;
  }
</style>

<script>
  function timestampToString(epoch_time) {
    const date = new Date(epoch_time * 1000);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }
  
  function resync() {
    fetch('/resync', { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        // Redirect to transactions page after resync
        window.location.href = '/transactions';
      })
      .catch(error => console.error('Error:', error));
  }
</script>
{% endblock %}